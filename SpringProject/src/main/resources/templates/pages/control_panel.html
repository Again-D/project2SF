<!DOCTYPE html>
<html
  lang="ko"
  xmlns:th="http://www.thymeleaf.org"
  xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
  layout:decorate="~{layout/base}"
>
  <head>
    <title layout:title="Control Panel">Control Panel</title>
  </head>
  <body>
    <div layout:fragment="content">
      <div class="p-6 bg-gray-100 min-h-screen">
        <h2 class="text-3xl font-bold text-gray-900 mb-8">컨트롤 패널</h2>

        <div class="flex flex-col items-start gap-6">
          <div class="bg-white p-6 rounded-lg shadow-lg w-full max-w-lg">
            <h3 class="text-xl font-semibold text-green-700 mb-4 border-b pb-2">
              시스템 제어
            </h3>
            <div class="flex items-center justify-between mb-3">
              <span class="text-gray-700"
                >상태:
                <span id="system-status" class="font-bold text-gray-500"
                  >OFF</span
                ></span
              >
            </div>
            <div class="space-y-3">
              <button
                id="btn-start"
                class="w-full flex items-center justify-center gap-2 bg-green-500 hover:bg-green-600 text-white font-bold py-3 px-4 rounded-md transition"
              >
                <svg
                  xmlns="http://www.w3.org/2000/svg"
                  width="20"
                  height="20"
                  viewBox="0 0 24 24"
                  fill="none"
                  stroke="currentColor"
                  stroke-width="2"
                  stroke-linecap="round"
                  stroke-linejoin="round"
                >
                  <polygon points="5 3 19 12 5 21 5 3"></polygon>
                </svg>
                시작
              </button>
              <button
                id="btn-stop"
                class="w-full flex items-center justify-center gap-2 bg-red-500 hover:bg-red-600 text-white font-bold py-3 px-4 rounded-md transition"
              >
                <svg
                  xmlns="http://www.w3.org/2000/svg"
                  width="20"
                  height="20"
                  viewBox="0 0 24 24"
                  fill="none"
                  stroke="currentColor"
                  stroke-width="2"
                  stroke-linecap="round"
                  stroke-linejoin="round"
                >
                  <rect x="3" y="3" width="18" height="18" rx="2" ry="2"></rect>
                </svg>
                중지
              </button>
            </div>
          </div>

          <div class="bg-white p-6 rounded-lg shadow-lg w-full max-w-lg">
            <h3 class="text-xl font-semibold text-green-700 mb-4 border-b pb-2">
              센서
            </h3>
            <div class="flex items-center justify-between mb-3">
              <span class="text-gray-700"
                >상태:
                <span id="sensor-status" class="font-bold text-gray-500"
                  >OFF</span
                ></span
              >
            </div>
            <div class="grid grid-cols-2 gap-3">
              <button
                id="btn-sensor-on"
                data-target="sensor"
                data-action="on"
                class="toggle-button flex items-center justify-center gap-2 bg-green-500 hover:bg-green-600 text-white font-bold py-3 px-4 rounded-md transition"
              >
                <svg
                  xmlns="http://www.w3.org/2000/svg"
                  width="20"
                  height="20"
                  viewBox="0 0 24 24"
                  fill="none"
                  stroke="currentColor"
                  stroke-width="2"
                  stroke-linecap="round"
                  stroke-linejoin="round"
                >
                  <path d="M18.36 6.64a9 9 0 1 1-12.73 0"></path>
                  <line x1="12" y1="2" x2="12" y2="12"></line>
                </svg>
                ON
              </button>
              <button
                id="btn-sensor-off"
                data-target="sensor"
                data-action="off"
                class="toggle-button flex items-center justify-center gap-2 bg-red-500 hover:bg-red-600 text-white font-bold py-3 px-4 rounded-md transition"
              >
                <svg
                  xmlns="http://www.w3.org/2000/svg"
                  width="20"
                  height="20"
                  viewBox="0 0 24 24"
                  fill="none"
                  stroke="currentColor"
                  stroke-width="2"
                  stroke-linecap="round"
                  stroke-linejoin="round"
                >
                  <path d="M18.36 6.64a9 9 0 1 1-12.73 0"></path>
                  <line x1="12" y1="2" x2="12" y2="12"></line>
                  <line x1="4.93" y1="4.93" x2="2" y2="2"></line>
                  <line x1="19.07" y1="4.93" x2="22" y2="2"></line>
                  <line x1="4.93" y1="19.07" x2="2" y2="22"></line>
                  <line x1="19.07" y1="19.07" x2="22" y2="22"></line>
                </svg>
                OFF
              </button>
            </div>
          </div>

          <div class="bg-white p-6 rounded-lg shadow-lg w-full max-w-lg">
            <h3 class="text-xl font-semibold text-green-700 mb-4 border-b pb-2">
              부저
            </h3>
            <div class="flex items-center justify-between mb-3">
              <span class="text-gray-700"
                >상태:
                <span id="buzzer-status" class="font-bold text-gray-500"
                  >OFF</span
                ></span
              >
            </div>
            <div class="grid grid-cols-2 gap-3">
              <button
                id="btn-buzzer-on"
                data-target="buzzer"
                data-action="on"
                class="toggle-button flex items-center justify-center gap-2 bg-green-500 hover:bg-green-600 text-white font-bold py-3 px-4 rounded-md transition"
              >
                <svg
                  xmlns="http://www.w3.org/2000/svg"
                  width="20"
                  height="20"
                  viewBox="0 0 24 24"
                  fill="none"
                  stroke="currentColor"
                  stroke-width="2"
                  stroke-linecap="round"
                  stroke-linejoin="round"
                >
                  <path d="M12 22c1.1 0 2-.9 2-2v-1H10v1c0 1.1.9 2 2 2z"></path>
                  <path
                    d="M10.3 2.25A7.5 7.5 0 0 0 4.5 9.5c0 4.5 3 8.5 3 8.5h9c0 0 3-4 3-8.5a7.5 7.5 0 0 0-5.8-7.25"
                  ></path>
                </svg>
                ON
              </button>
              <button
                id="btn-buzzer-off"
                data-target="buzzer"
                data-action="off"
                class="toggle-button flex items-center justify-center gap-2 bg-red-500 hover:bg-red-600 text-white font-bold py-3 px-4 rounded-md transition"
              >
                <svg
                  xmlns="http://www.w3.org/2000/svg"
                  width="20"
                  height="20"
                  viewBox="0 0 24 24"
                  fill="none"
                  stroke="currentColor"
                  stroke-width="2"
                  stroke-linecap="round"
                  stroke-linejoin="round"
                >
                  <path d="M12 22c1.1 0 2-.9 2-2v-1H10v1c0 1.1.9 2 2 2z"></path>
                  <path
                    d="M10.3 2.25A7.5 7.5 0 0 0 4.5 9.5c0 4.5 3 8.5 3 8.5h9c0 0 3-4 3-8.5a7.5 7.5 0 0 0-5.8-7.25"
                  ></path>
                  <line x1="1" y1="1" x2="23" y2="23"></line>
                </svg>
                OFF
              </button>
            </div>
          </div>
        </div>
      </div>
    </div>
    <th:block layout:fragment="script"></script>
    <script>
      document.addEventListener("DOMContentLoaded", () => {
                // === 상태 표시 엘리먼트와 버튼 그룹 ===
                const systemStatus = document.getElementById("system-status");
                const sensorStatus = document.getElementById("sensor-status");
                const buzzerStatus = document.getElementById("buzzer-status");

                const startBtn = document.getElementById("btn-start");
                const stopBtn = document.getElementById("btn-stop");

                const toggleButtons = document.querySelectorAll(".toggle-button");

                // === 유틸: 상태 텍스트 + 색상 클래스 변경 ===
                function updateStatus(el, isOn) {
                    el.textContent = isOn ? "ON" : "OFF";
                    el.classList.toggle("text-green-600", isOn);
                    el.classList.toggle("text-gray-600", !isOn);
                }

                // === 유틸: 버튼 색상 상태 변경 (하이라이트) ===
                function setActiveButton(activeBtn, inactiveBtn) {
                    activeBtn.classList.add("ring-2", "ring-offset-2", "ring-green-300", "font-bold");
                    inactiveBtn.classList.remove("ring-2", "ring-offset-2", "ring-green-300", "font-bold");
                }

                function setInactiveButton(activeBtn, inactiveBtn) {
                    activeBtn.classList.add("ring-2", "ring-offset-2", "ring-red-300", "font-bold");
                    inactiveBtn.classList.remove("ring-2", "ring-offset-2", "ring-red-300", "font-bold");
                }

                // === 시스템 시작/중지 버튼 제어 ===
                startBtn.addEventListener("click", () => {
                    updateStatus(systemStatus, true);
                    setActiveButton(startBtn, stopBtn);
                    sendControlCommand("system", "start"); // 서버에 시작 명령 전송
                });

                stopBtn.addEventListener("click", () => {
                    updateStatus(systemStatus, false);
                    setInactiveButton(stopBtn, startBtn);
                    sendControlCommand("system", "stop"); // 서버에 중지 명령 전송
                });

                // === 센서/부저 제어 버튼 제어 ===
                toggleButtons.forEach((btn) => {
                    btn.addEventListener("click", () => {
                        const target = btn.dataset.target; // sensor or buzzer
                        const action = btn.dataset.action; // on or off
                        const statusEl = document.getElementById(`${target}-status`);
                        const btnOn = document.getElementById(`btn-${target}-on`);
                        const btnOff = document.getElementById(`btn-${target}-off`);

                        const isOn = action === "on";
                        updateStatus(statusEl, isOn);

                        if (isOn) {
                            setActiveButton(btnOn, btnOff);
                        } else {
                            setInactiveButton(btnOff, btnOn);
                        }
                        sendControlCommand(target, action); // 서버에 명령 전송
                    });
                });

                // === 초기 상태 설정 ===
                updateStatus(systemStatus, false);
                setInactiveButton(stopBtn, startBtn);

                updateStatus(sensorStatus, false);
                setInactiveButton(document.getElementById("btn-sensor-off"), document.getElementById("btn-sensor-on"));

                updateStatus(buzzerStatus, false);
                setInactiveButton(document.getElementById("btn-buzzer-off"), document.getElementById("btn-buzzer-on"));

                // === 서버에 제어 명령 전송 ===
                function sendControlCommand(target, action) {
                    const data = new URLSearchParams();
                    data.append('action', action);

                    fetch(`/control/${target}`, { //  /control/system, /control/sensor, /control/buzzer  POST 요청
                        method: 'POST',
                        body: data,
                        headers: {
                            'Content-Type': 'application/x-www-form-urlencoded',
                        },
                    })
                    .then(response => {
                        if (!response.ok) {
                            throw new Error(`HTTP error! status: ${response.status}`);
                        }
                        return response.text(); // 또는 response.json()
                    })
                    .then(data => {
                        console.log('Success:', data);
                        // 필요한 경우, 응답에 따라 UI 업데이트 (예: 토스트 메시지 표시)
                    })
                    .catch(error => {
                        console.error('Error:', error);
                        alert('Failed to control ' + target + '.  Check console for details.');
                        // 오류 처리: 사용자에게 알림 메시지 표시
                    });
                }
            });
    </script>
    </th:block>
  </body>
</html>
